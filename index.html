<html>
<head>
   <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
   <link rel='stylesheet' href='https://unpkg.com/formiojs@latest/dist/formio.full.min.css'>
   <script src='https://unpkg.com/formiojs@latest/dist/formio.full.min.js'></script>
   <script src='calc/calc.js'></script>
   <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
   
   <script type='text/javascript'>
var form = null;
function parse_query_string(query) {
  var vars = query.split("&");
  var query_string = {};
  for (var i = 0; i < vars.length; i++) {
    var pair = vars[i].split("=");
    // If first entry with this name
    if (typeof query_string[pair[0]] === "undefined") {
      query_string[pair[0]] = decodeURIComponent(pair[1]);
      // If second entry with this name
    } else if (typeof query_string[pair[0]] === "string") {
      var arr = [query_string[pair[0]], decodeURIComponent(pair[1])];
      query_string[pair[0]] = arr;
      // If third or later entry with this name
    } else {
      query_string[pair[0]].push(decodeURIComponent(pair[1]));
    }
  }
  return query_string;
}   

function getLocalResource(resloc,resdatatype) {
   var res =(function() {
     var resdata = null;
     $.ajax({
         'async': false,
         'global': false,
         'url': resloc,
         'dataType': resdatatype,
         'success': function (data) {
             resdata = data;
         }
     });
     return resdata;
   })();
   return res;
}

function getPDF(fn,subm_data,pdftool,signpdf,lockpdf) {
   console.log('Getting PDF for xsl '+fn+'...');
   var xsld = [location.protocol, '//', location.host, location.pathname].join('') + "xsl/" + fn + '.xsl';   
   var prexsld = [location.protocol, '//', location.host, location.pathname].join('') + "xsl/twf.xsl";   
   
var newTabWindow = window.open('waiting_for_pdf.html');
   
var req = new XMLHttpRequest();
req.open("POST", "https://sasapdfproxy.azurewebsites.net/pdf", true);
req.responseType = "text";
req.setRequestHeader("Content-type", "application/json");
req.send('{"data" : '+JSON.stringify(subm_data)+',"xsl" : "'+xsld+',"xslPre" : "'+prexsld+'","lockPdfWithPassword" : '+lockpdf+',"signPdf":'+signpdf+',"pdf_tool_name":"'+pdftool+'"}');

req.onload = function (event) {
   var d = new Date();
   var fname = fn+'_'+d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate()+'-'+d.getHours()+'-'+d.getMinutes()+'-'+d.getSeconds()+'-'+d.getMilliseconds()+'.pdf';
   console.log('pdfloc='+req.response);
   newTabWindow.location.replace(req.response);
};   
  
  form.emit('submitDone');
}   

window.onload = function() {
  jsonform = getLocalResource("json/hrleasing.json","json");
  form = new FormioForm(document.getElementById('formio'),{i18n: {lng: 'de-AT', resources: {}}});
  form.form = jsonform;

   form.ready.then(function() {
      var query = window.location.search.substring(1);
      var qs = '{}';
      if (query!=null && query!='') {
         var qs = parse_query_string(query);
      }
      var fa = qs['inpfinanceamount'];
      if (fa) {
         qs['inpfinanceamount']=parseInt(fa);
      }
      
      console.log('qs='+JSON.stringify(qs));
      console.log('fs='+JSON.stringify(form.submission));
      var datamerged = $.extend(form.submission.data, qs);
      console.log('jsonmerge='+JSON.stringify(datamerged));
      var initdata = calculate(datamerged);
      console.log('id='+JSON.stringify(initdata));
      var initjson = JSON.parse('{"data":'+JSON.stringify(initdata)+'}');
      form.submission = initjson;
   });
     
   form.on('customEvent', function(event) {
      var should_sign_pdf = false;
      var should_lock_pdf_with_password = false;
      var pdf_tool_name = "ahformatter";
      if(event.component.key.lastIndexOf("fop") == (event.component.key.length - "fop".length)) {
         pdf_tool_name="fop";
      } else if(event.component.key.lastIndexOf("altosoft") == (event.component.key.length - "altosoft".length)) {
         pdf_tool_name="altosoft";
      }
      var isahf = event.component.key.lastIndexOf("ahformatter")!=-1;
      if (isahf) {
      console.log('ahformatter');
         if(event.component.key.lastIndexOf("signed")!=-1) {
            console.log('..signing');
            should_sign_pdf=true;
         }
         if(event.component.key.lastIndexOf("password")!=-1) {
            console.log('..pwd protecting');
            should_lock_pdf_with_password=true;
         }
      }
      if(event.component.key=='openPdfInBrowser') {
         getPDF('get_allitems',event.data,pdf_tool_name,should_sign_pdf,should_lock_pdf_with_password);
      } else {
         if (event.type=='getSLeasingPDF') {               
            if (event.component.key.lastIndexOf("fop") == (event.component.key.length - "fop".length)) {
               alert('FOP currently can\'t do graphics');
            } else {
               getPDF('sleasing'+(isahf ? '' : '-fullimgpaths'),event.data,pdf_tool_name,should_sign_pdf,should_lock_pdf_with_password);
            }
         } else if (event.type=='getSLeasingPDFNoSVGAndImages') {
            getPDF('sleasing-nosvgnoimages',event.data,pdf_tool_name,should_sign_pdf,should_lock_pdf_with_password);
         } else if (event.type==='getPlainDataPDF') {
            getPDF('get_allitems',event.data,pdf_tool_name,should_sign_pdf,should_lock_pdf_with_password);
         }
      }
   });
  
};

   </script>
</head>
<body>
<div class="container bg-faded">
   <div class="row">
        <div class="col-12" id="formio"></div>
    </div>
 </div>
<div class="center" id="holder"></div>

</body>
</html>

